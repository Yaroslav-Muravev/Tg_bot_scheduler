# Tg_bot_scheduler

## Описание

Это Telegram-бот для бронирования лабораторного оборудования. Бот позволяет:

* выбирать оборудование через inline-кнопки (пагинация по 10 элементов),
* настраивать количество через кнопки «+» / «-» и добавлять в корзину,
* просматривать и редактировать корзину (−1 единица / удалить строку / очистить),
* вводить ресурсы вручную в текстовом формате,
* автоматически проверять доступность ресурсов по дате/времени (учитывает уже существующие брони в Google Sheets),
* подтверждать бронирование через inline-кнопки (Подтвердить / Отмена),
* сохранять бронь в Google Sheets.

## Фичи

* Пагинация инвентаря (по 10 элементов, стрелки «◀️/▶️»).
* Безопасные короткие `callback_data` (ключи вида `i{idx}` и `c{idx}`), сопоставление хранится в FSM состоянии.
* Удаление одной единицы из корзины и удаление строки полностью.
* Ручной ввод ресурсов (формат: `Oscilloscope:2; Laptop:1` — разделитель `;` или `,`, при отсутствии числа считается 1).
* Проверка конфликтов по времени (пересечение интервалов).

## Требования

* Python 3.10+
* Библиотеки (пример):

  * `aiogram`
  * `gspread`
  * `google-auth` (через `google.oauth2.service_account`)
  * `python-dotenv`

Пример установки зависимостей:

```bash
python -m pip install aiogram gspread google-auth python-dotenv
```

(При необходимости указывайте версии в `requirements.txt`.)

## Настройка Google Service Account и Google Sheets

1. Создайте сервисный аккаунт в Google Cloud и скачайте ключ JSON.
2. Откройте Google Sheets (файл бронирований) и поделитесь им с email сервисного аккаунта (в режиме редактора).
3. В таблице должны быть два листа (или укажите свои имена):

   * `Ресурсы лаборатории` — лист с инвентарём. Должен содержать заголовки, например: `Наименование`, `Количество`.
   * `Бронирование ресурсов` — лист с записями бронирований.

> Формат записей в листе `BOOKINGS` (в том же порядке при записи):
>
> ```text
> Дата проведения работ (YYYY-MM-DD)
> Имя и фамилия сотрудника(-ков)
> Необходимые ресурсы (например: Oscilloscope:2;Laptop:1)
> Время начала работ (HH:MM)
> Время окончания работ (HH:MM)
> Имя руководителя проекта
> ```

## Переменные окружения (.env)

Создайте файл `.env` рядом с кодом и заполните:

```dotenv
TELEGRAM_BOT_TOKEN=123456:ABCDEF...
SERVICE_ACCOUNT_FILE=/path/to/service_account.json
SPREADSHEET_ID=1AbCdEfGhIjKlMnOpQrStUvWxYz1234567890
```

* `SERVICE_ACCOUNT_FILE` — путь к JSON ключу сервисного аккаунта.
* `SPREADSHEET_ID` — ID или полная ссылка на Google Spreadsheet.

## Запуск бота (локально)

```bash
export $(cat .env | xargs)
python main.py
```

Или с `systemd` / Docker по вашему усмотрению.

## Использование (команды)

* `/start` — приветствие и инструкции.
* `/help` — подсказки по использованию.
* `/list` — показывает весь инвентарь.
* `/book` — начать процесс бронирования (диалог):

  1. Ввести дату (YYYY-MM-DD)
  2. Ввести время начала (HH:MM)
  3. Ввести время окончания (HH:MM)
  4. Ввести имя сотрудника(-ов)
  5. Выбрать ресурсы через кнопки (пагинация) или ввести вручную
  6. Ввести имя руководителя проекта
  7. Подтвердить через кнопки `Подтвердить ✅` / `Отмена ❌` — бронь записывается в Google Sheets

## Формат ввода ресурсов (текстом)

Поддерживаемые варианты:

* `Oscilloscope:2; Laptop:1`
* `Oscilloscope 2, Laptop 1`
* `Oscilloscope` (тогда количество = 1)

Скрипт нормализует разделители `;`, `,`, и `\n`.

## Примечания по реализации и предостережения

* Telegram ограничивает размер `callback_data` (~64 байта). В реализации используется короткий безопасный ключ (`i{idx}`, `c{idx}`) вместо полного имени оборудования.
* При построении `InlineKeyboardMarkup` используйте `InlineKeyboardMarkup(inline_keyboard=rows)` — не передавайте параметр `row_width` напрямую (в новых версиях pydantic/aiogram это может вызвать `ValidationError`).
* Для `InlineKeyboardButton` всегда используйте именованные аргументы: `InlineKeyboardButton(text=..., callback_data=...)`.
* Если видите ошибку `BUTTON_DATA_INVALID`, проверьте длину и формат `callback_data` (должна быть короткой и безопасной).
* Поскольку сопоставления ключ→имя хранятся в FSM state, если пользователь долго не отвечает и данные инвентаря меняются, возможны устаревшие клавиши. В этом случае бот предлагает обновить клавиатуру.

## Тестирование

* Создайте тестовую Google таблицу и тестовый сервисный аккаунт (не используйте рабочие данные).
* Проверьте сценарии:

  * выбор оборудования по кнопкам и добавление в корзину
  * пагинация (страницы вперед/назад)
  * удаление по −1 и удаление строки
  * ручной ввод ресурсов
  * проверка занятости при пересечении временных интервалов

## Отладка / логирование

В `main.py` включено базовое логирование:

```py
import logging
logging.basicConfig(level=logging.INFO)
```

При возникновении ошибок смотрите логи — там будут трассировки (pydantic, Telegram API, gspread).

## Возможные доработки

* Использовать UUID-ключи вместо индексных ключей (`i{idx}`) для устойчивости при параллельных показах клавиатур.
* Добавить ограничение одновременных бронирований по пользователю.
* Интеграция с календарём (Google Calendar) для отображения занятости в календарном виде.
* Веб-интерфейс для администрирования инвентаря и подтверждений.

## Лицензия

MIT — используйте как хотите, указывайте авторство при распространении.


